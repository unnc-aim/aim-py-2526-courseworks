name: Sync Develop Branch

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-develop:
    name: Sync develop branch with main
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # èŽ·å–å®Œæ•´çš„ git åŽ†å²ï¼Œä»¥ä¾¿è¿›è¡Œåˆ†æ”¯æ“ä½œ
          fetch-depth: 0
          # ä½¿ç”¨ GitHub Token è¿›è¡Œèº«ä»½éªŒè¯
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all branches
        run: |
          git fetch origin main
          git fetch origin develop

      - name: Check if develop branch exists
        id: check-develop
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/develop; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… develop branch exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âŒ develop branch does not exist"
          fi

      - name: Create develop branch if it doesn't exist
        if: steps.check-develop.outputs.exists == 'false'
        run: |
          echo "ðŸ”§ Creating develop branch from main..."
          git checkout -b develop
          git push origin develop
          echo "âœ… develop branch created and pushed"

      - name: Sync develop with main
        if: steps.check-develop.outputs.exists == 'true'
        run: |
          echo "ðŸ”„ Syncing develop branch with main..."

          # åˆ‡æ¢åˆ° develop åˆ†æ”¯
          git checkout develop

          # èŽ·å–å½“å‰åˆ†æ”¯çš„æœ€æ–°æäº¤ hash
          DEVELOP_BEFORE=$(git rev-parse HEAD)
          echo "ðŸ“‹ develop branch before sync: $DEVELOP_BEFORE"

          # èŽ·å– main åˆ†æ”¯çš„æœ€æ–°æäº¤ hash
          MAIN_COMMIT=$(git rev-parse origin/main)
          echo "ðŸ“‹ main branch commit: $MAIN_COMMIT"

          # æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥
          if [ "$DEVELOP_BEFORE" = "$MAIN_COMMIT" ]; then
            echo "âœ… develop branch is already up to date with main"
            exit 0
          fi

          # å°è¯•å¿«è¿›åˆå¹¶ main åˆ° develop
          echo "ðŸš€ Attempting fast-forward merge..."
          if git merge --ff-only origin/main; then
            echo "âœ… Fast-forward merge successful"
            
            # æŽ¨é€æ›´æ–°åˆ°è¿œç¨‹ develop åˆ†æ”¯
            git push origin develop
            
            DEVELOP_AFTER=$(git rev-parse HEAD)
            echo "ðŸ“‹ develop branch after sync: $DEVELOP_AFTER"
            echo "ðŸŽ‰ develop branch successfully synced with main"
            
          else
            echo "âš ï¸ Fast-forward merge failed, there might be conflicts or diverged commits"
            echo "ðŸ“‹ This usually happens when develop has commits that are not in main"
            echo "ðŸ” Checking for diverged commits..."
            
            # æ£€æŸ¥ develop æ˜¯å¦æœ‰ main æ²¡æœ‰çš„æäº¤
            DIVERGED_COMMITS=$(git rev-list --count origin/main..develop)
            echo "ðŸ“Š Number of commits in develop not in main: $DIVERGED_COMMITS"
            
            if [ "$DIVERGED_COMMITS" -gt 0 ]; then
              echo "âš ï¸ develop branch has $DIVERGED_COMMITS commits that are not in main"
              echo "ðŸ”§ This requires manual intervention or a different sync strategy"
              echo "ðŸ“‹ Diverged commits:"
              git log --oneline origin/main..develop
              
              echo "ðŸ’¡ Consider creating a pull request to merge these changes to main first"
              exit 1
            else
              echo "âŒ Unexpected merge failure"
              exit 1
            fi
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸ”„ Develop Branch Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: Push to main branch" >> $GITHUB_STEP_SUMMARY
          echo "- **Main commit**: \`$(git rev-parse origin/main)\`" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-develop.outputs.exists }}" = "true" ]; then
            echo "- **Develop branch**: Existed and processed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Develop branch**: Created from main" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **Result**: develop branch is now in sync with main" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Result**: Sync failed - manual intervention may be required" >> $GITHUB_STEP_SUMMARY
          fi